// Mock-реализация GigaChat с детерминированным поведением

import { GigaChatResponse, UserLevel } from "./types";

// Генерация случайной темы для сценария "random"
export async function generateRandomTopic(level: UserLevel): Promise<string> {
  // Mock: генерируем тему в зависимости от уровня
  const experiencedTopics = [
    "Создать мини-фреймворк для роутинга на TypeScript",
    "Реализовать простой state manager с подпиской на изменения",
    "Написать CLI-утилиту для генерации компонентов React",
    "Создать библиотеку для валидации форм с поддержкой async правил",
    "Разработать систему middleware для обработки HTTP-запросов",
  ];

  const beginnerTopics = [
    "Создать todolist с фильтрацией задач",
    "Разработать калькулятор с историей операций",
    "Написать приложение для заметок с локальным хранением",
    "Создать простой таймер с уведомлениями",
    "Разработать форму с валидацией полей",
  ];

  const topics = level === "experienced" ? experiencedTopics : beginnerTopics;
  const randomIndex = Math.floor(Math.random() * topics.length);
  
  return topics[randomIndex];
}

// Список абстрактных слов/идей, которые не подходят
const ABSTRACT_IDEAS = [
  "собака",
  "кот",
  "кошка",
  "машина",
  "автомобиль",
  "дом",
  "игра",
  "приложение",
  "сайт",
  "программа",
  "животное",
  "растение",
  "еда",
  "спорт",
  "музыка",
  "книга",
  "фильм",
];

// Конкретные варианты для абстрактных идей
const CONCRETE_VARIANTS: Record<string, string[]> = {
  собака: [
    "Приложение для выгула собак | Сервис для поиска попутчиков для прогулок с собаками в вашем районе с рейтингами и отзывами | Профили собак, геолокация, чат, календарь встреч, рейтинг пользователей | Данные о собаке (порода, возраст), расписание прогулок, история встреч | Минимум 10 пользователей могут запланировать совместную прогулку",
    "База данных пород собак | Справочник с подробным описанием пород, характеристиками, фотографиями и подбором породы по образу жизни | Каталог пород, фильтры, избранное, тест-подбор породы, статьи по уходу | Породы (описание, характеристики, требования), пользовательское избранное | Каталог из 50+ пород с полным описанием и рабочим тестом подбора",
    "Трекер здоровья собаки | Приложение для отслеживания прививок, визитов к ветеринару, веса и активности питомца | Медкарта, напоминания о прививках, графики веса, дневник симптомов, контакты ветклиник | Медицинские записи, график прививок, вес по датам, заметки о здоровье | Полная медкарта с историей за год и действующими напоминаниями",
    "Интернет-магазин товаров для собак | E-commerce платформа с каталогом товаров, корзиной, оформлением заказа и отслеживанием доставки | Каталог товаров, корзина, оформление заказа, личный кабинет, история покупок | Товары (описание, цена, фото), заказы, пользователи, статусы доставки | Минимум 20 товаров, работающая корзина и оформление тестового заказа",
    "Соцсеть для владельцев собак | Платформа для обмена фото питомцев, советами по уходу, поиска потерянных собак | Профили собак, лента постов, комментарии, лайки, объявления о пропаже, локальные группы | Пользователи, посты, фото, комментарии, геометки для пропавших собак | 20+ пользователей, публикация постов, комментарии и работающий поиск по пропавшим",
  ],
  кот: [
    "Календарь ухода за кошкой | Приложение для отслеживания кормлений, игр, чистки лотка и визитов к ветеринару | Расписание кормлений, трекер активности, напоминания, дневник поведения, контакты ветклиник | Расписания по датам, медицинские записи, заметки о поведении | Полный календарь ухода на месяц с автоматическими напоминаниями",
    "Каталог кормов для кошек | База данных с отзывами, составом, ценами и рекомендациями по выбору корма | Каталог кормов, фильтры по составу, сравнение, отзывы, калькулятор порций | Корма (состав, производитель, цена), отзывы пользователей, рейтинги | 100+ кормов с полным описанием и работающей системой фильтров",
    "Игры для кошек на планшете | Интерактивные анимации для развлечения кошек с отслеживанием активности | Разные виды игр (рыбки, мышки, лазер), таймер сессии, статистика игр | История игровых сессий, любимые игры кота | 5 разных игр с сохранением статистики за неделю",
    "Потерянные кошки | Сервис для публикации объявлений о потерянных и найденных кошках с геолокацией | Карта находок, объявления с фото, чат, уведомления о находках поблизости | Объявления (фото, описание, геолокация), чаты между пользователями | 50+ объявлений и работающая система уведомлений по геолокации",
    "Дневник котенка | Приложение для владельцев котят с советами по развитию, вакцинацией и дрессировкой | Чек-листы по возрасту, трекер веса, график прививок, видео-уроки, заметки | Возраст котенка, вес по датам, выполненные прививки, заметки о развитии | Полный план развития до года с выполненными чек-листами",
  ],
  машина: [
    "Учет расходов на авто | Приложение для отслеживания затрат на топливо, ремонт, страховку и обслуживание | Учет заправок, история ТО, напоминания о страховке, статистика расходов, экспорт отчетов | Автомобиль, чеки, пробег, категории расходов | Год истории расходов с детальной статистикой по категориям",
    "Поиск попутчиков | Сервис для поиска попутчиков на дальние поездки с разделением расходов | Маршруты, профили водителей и пассажиров, чат, рейтинги, оплата | Маршруты, пользователи, отзывы, история поездок | 20+ успешных поездок с работающей системой рейтингов",
    "История обслуживания авто | База данных всех работ по ТО с фото, чеками и напоминаниями | Журнал ТО, загрузка чеков, фото до/после, напоминания по пробегу, контакты СТО | История работ, пробег, документы, запланированные ТО | Полная история за 3 года с напоминаниями о следующем ТО",
    "Каталог автозапчастей | Поиск и сравнение цен на автозапчасти с разных площадок | Поиск по VIN/модели, сравнение цен, отзывы, история покупок, избранное | Запчасти, цены от поставщиков, пользовательские отзывы | 1000+ позиций с работающим сравнением цен от 3+ поставщиков",
    "Дорожный дневник | Приложение для записи автопутешествий с маршрутами, фото и заметками | Карта маршрутов, фотогалерея, заметки, учет расходов, экспорт в PDF | Поездки, точки на карте, фото, расходы | 5+ путешествий с полным маршрутом и фотоальбомом",
  ],
  default: [
    "Конкретное приложение с четкими функциями | Определите основную задачу, которую будет решать ваше приложение | Список ключевых возможностей, пользовательские сценарии | Структура данных, которые нужно хранить | Измеримый критерий завершения проекта",
    "Специализированный инструмент | Инструмент для решения конкретной проблемы пользователей в определенной области | Основной функционал, дополнительные возможности | Пользовательские данные, настройки, результаты работы | Набор функций, который делает инструмент полезным",
    "Учебный проект с реальной пользой | Приложение, которое можно использовать в повседневной жизни | Базовые функции, интеграции, отчеты | Пользовательский контент, история действий | Работающий MVP с основным функционалом",
  ],
};

// Проверка своей темы для сценария "own"
export async function validateOwnIdea(
  idea: string,
  level: UserLevel
): Promise<GigaChatResponse> {
  // Детерминированное поведение:
  // 1. Проверяем, является ли идея абстрактной (одно слово из списка)
  // 2. Если текст короче 20 символов → "не подходит" + варианты докрутки
  // 3. Иначе → "Тема подходит" + 3 подсказки
  
  const trimmedIdea = idea.trim().toLowerCase();
  
  // Проверка на абстрактные идеи
  for (const abstractWord of ABSTRACT_IDEAS) {
    if (trimmedIdea === abstractWord || trimmedIdea.includes(abstractWord)) {
      const variants = CONCRETE_VARIANTS[abstractWord] || CONCRETE_VARIANTS.default;
      const suggestions = variants.map((variant) => {
        const parts = variant.split("|").map((p) => p.trim());
        if (parts.length >= 5) {
          const [name, description, features, data, criteria] = parts;
          return `${name}\n${description}\nОсновные возможности: ${features}\nДанные: ${data}\nКритерий готовности: ${criteria}`;
        }
        return variant;
      });

      return {
        suitable: false,
        advice: suggestions.slice(0, 5),
      };
    }
  }
  
  if (trimmedIdea.length < 20) {
    // Тема слишком простая/короткая
    const suggestions = [
      `${idea.trim()} - система управления\nПриложение для управления данными о ${trimmedIdea} с полным CRUD функционалом\nОсновные возможности: Создание, редактирование, удаление записей, поиск, фильтрация\nДанные: Записи с атрибутами, метаданные, история изменений\nКритерий готовности: Работающий CRUD для 100+ записей с поиском`,
      
      `${idea.trim()} - трекер и аналитика\nСистема для отслеживания метрик и статистики по ${trimmedIdea} с графиками\nОсновные возможности: Ввод данных, графики динамики, экспорт в CSV, напоминания\nДанные: Временные ряды, категории, пользовательские метки\nКритерий готовности: График за месяц с экспортом и 5+ метрик`,
      
      `${idea.trim()} - каталог и справочник\nБаза знаний о ${trimmedIdea} с поиском, фильтрами и избранным\nОсновные возможности: Каталог, детальные карточки, поиск, фильтры, избранное\nДанные: Записи справочника, характеристики, пользовательское избранное\nКритерий готовности: 50+ записей с работающей системой поиска и фильтров`,
      
      `${idea.trim()} - планировщик и органайзер\nПриложение для планирования и организации действий связанных с ${trimmedIdea}\nОсновные возможности: Календарь, задачи, напоминания, чек-листы, заметки\nДанные: События, задачи, приоритеты, статусы выполнения\nКритерий готовности: Месячный календарь с 20+ задачами и напоминаниями`,
      
      `${idea.trim()} - социальная платформа\nСообщество для обмена опытом и контентом про ${trimmedIdea}\nОсновные возможности: Профили, посты, комментарии, лайки, подписки, поиск\nДанные: Пользователи, публикации, связи между пользователями, медиа\nКритерий готовности: 10+ пользователей, 50+ постов, работающая лента`,
    ];

    return {
      suitable: false,
      advice: suggestions.slice(0, 5), // возвращаем 5 вариантов
    };
  }

  // Тема подходит
  const adviceForExperienced = [
    "Начните с проектирования архитектуры и выбора технологического стека",
    "Разбейте проект на модули и определите интерфейсы между ними",
    "Настройте систему сборки, линтинг и автоматические тесты с самого начала",
  ];

  const adviceForBeginner = [
    "Начните с создания простого прототипа основной функциональности",
    "Разделите задачу на маленькие шаги и реализуйте их последовательно",
    "Не бойтесь искать примеры кода и документацию для нужных технологий",
  ];

  return {
    suitable: true,
    topic: idea.trim(),
    advice: level === "experienced" ? adviceForExperienced : adviceForBeginner,
  };
}

